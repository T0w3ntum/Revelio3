package revelioprofile

import (
	"Revelio3/librevelio"
	"fmt"
	"os/exec"
	"strconv"
	"strings"
	"sync"
	"time"
)

type RevelioProfile struct{}

func worker(command string, args []string, outputfile string, r *librevelio.Revelio, wg *sync.WaitGroup) {
	cmd := exec.Command(command, args...)
	err := cmd.Run()
	if err != nil {
		wg.Done()
		return
	}
	printResults(outputfile, wg, r)
	return
}

func printResults(outputfile string, wg *sync.WaitGroup, r *librevelio.Revelio) {
	data, _ := r.NmapParse(outputfile)
	for _, h := range data.Hosts {
		var hostIP string
		var ports []int

		for _, address := range h.Addresses {
			if address.AddrType == "ipv4" {
				hostIP = address.Addr
			}
		}
		for _, p := range h.Ports {
			ports = append(ports, p.PortId)
		}
		allPorts := strings.Trim(strings.Join(strings.Fields(fmt.Sprint(ports)), ","), "[]")
		r.ClearProgress()
		fmt.Printf("[+] Host: %s - %s\n", hostIP, allPorts)
	}
	wg.Done()
}

func (s RevelioProfile) Process(r *librevelio.Revelio, ip string, wg *sync.WaitGroup) ([]librevelio.Result, error) {
	var portgroup [5]string
	portgroup[0] = "21-23,25-26,53,80-81,110-111,113,135,139,143,179,199,443,445,465,514-515,548,554,587,646,993,995,1025-1027,1433,1720,1723,2000-2001,3306,3389,5060,5666,5900,6001,8000,8008,8080,8443,8888,10000,32768,49152,49154"
	portgroup[1] = "1,7,9,13,17,19,37,79,82,88,100,106,119,144,255,389,427,444,513,543-544,625,631,636,808,873,990,1000,1024,1028-1031,1038-1039,1041,1044,1048-1049,1053-1054,1056,1064-1066,1069,1071,1110,1755,1801,1900,2049,2103,2105,2107,2121,2601,2717,2869,2967,3000-3001,3128,3689,3703,3986,4001,4899,5000-5001,5009,5050-5051,5101,5120,5190,5357,5432,5631,5800,5901,6000,6004,6646,7000,7070,8009-8010,8031,8081,9000,9090,9100,9102,9999,10010,49153,49155-49157"
	portgroup[2] = "3-4,6,20,24,30,32-33,42-43,49,83,85,89-90,99,146,161,163,211-212,222,254,264,280,306,311,340,366,407,425,458,464,497,500,512,541,563,593,648,691,705,711,749,787,800,880,888,898,900-902,912,987,992,999,1001-1002,1022-1023,1032-1037,1040,1042-1043,1045-1047,1050-1052,1055,1057-1063,1067-1068,1070,1072-1075,1077-1083,1085-1089,1093-1094,1096-1100,1104,1106-1108,1111,1124,1148,1152,1169,1183,1186,1218,1234,1247-1248,1272,1296,1310-1311,1334,1352,1494,1500-1501,1503,1521,1580,1666,1687,1700,1717-1718,1761,1782-1783,1840,1863-1864,1935,1947,1998-1999,2002-2010,2020,2030,2033,2065,2100,2119,2126,2135,2144,2160-2161,2179,2190-2191,2222,2251,2260,2301,2381,2383,2399,2401,2492,2500,2522,2525,2602,2604-2605,2607,2701-2702,2718,2809,2811,2875,2998,3005,3011,3017,3030-3031,3052,3071,3077,3211,3260-3261,3268-3269,3283,3300-3301,3323,3325,3333,3351,3367,3369-3372,3404,3476,3493,3546,3551,3580,3659,3690,3737,3766,3784,3801,3827-3828,3851,3871,3880,3918,3995,3998,4000,4002-4003,4006,4045,4111,4126,4129,4242,4443-4444,4446,4449,4662,5002-5004,5030,5054,5100,5102,5200,5214,5222,5225-5226,5269,5280,5298,5405,5414,5431,5500,5510,5550,5555,5566,5633,5679,5718,5801,5810,5822,5825,5859,5877,5902-5904,5910-5911,5915,5922,5925,5959-5963,5987-5989,6002-6003,6005,6059,6101,6106,6112,6123,6129,6156,6389,6502,6543,6580,6666-6667,6788-6789,6881,6901,6969,7001-7002,7007,7019,7100,7103,7106,7200,7402,7435,7443,7512,7625,7627,7741,7777-7778,7911,7937-7938,8001-8002,8007,8011,8021,8082-8090,8100,8181,8192-8194,8222,8291,8333,8400,8402,8600,8649,8651-8652,8701,8873,8899,8994,9001-9002,9009-9011,9050,9071,9080,9101,9207,9220,9290,9415,9485,9500,9502-9503,9535,9593-9595,9618,9876,9900,9968,10001-10002,10012,10024-10025,10243,10566,10616-10617,10621,10626,10628-10629,11110,11967,12000,12345,13456,13722,13782-13783,14000,14238,14442,15000,15002-15003,15660,16001,16016,16018,16992-16993,17988,19101,19801,19842,20000,20005,20031,20221-20222,20828,21571,22939,23502,24800,25734,27000,27715,28201,30000,30718,31038,32769-32776,32781-32782,33354,33899,34571-34573,35500,40193,42510,45100,48080,49158-49160,49999-50003,50006,50800,51103,52822,52869,55555,55600,57294,58080,60020,63331,64623,64680,65000,65129,65389"
	portgroup[3] = "27,55,57,59,70,77,84,86-87,98,102,109,123,125,127,157,210,220,223,225,250-252,256-257,259,301,333,388,406,411,416-417,419,441-442,447,475,481,502,523-524,540,545,555-557,600,602,606,610,616-617,621,623,639,641,655,657,659-660,666-669,674,683-684,687,690,700-701,709-710,713-715,720,722,725-726,728-732,740,748,754,757-758,765,777-778,780,782-783,786,790,792,795,801-803,805-806,822-823,825,829,839-840,843,846,856,859,862,864,874,878,903-905,911,913,918,921-922,924,928,930-931,943,953,969,971,980-981,996,998,1004-1015,1020-1021,1076,1084,1090-1092,1095,1101-1103,1105,1109,1112-1114,1116-1119,1121-1123,1125-1128,1130-1132,1134-1138,1141,1143-1145,1147,1149-1151,1153-1154,1156-1159,1162-1168,1173-1176,1179-1180,1182,1184-1185,1187-1188,1190-1192,1194-1196,1198-1201,1204,1207-1213,1215-1217,1220-1223,1228-1229,1233,1236,1239-1241,1243-1244,1249-1251,1259,1261-1262,1264,1268,1270-1271,1276-1277,1279,1282,1287,1290-1291,1297,1299-1303,1305-1309,1314-1319,1321-1322,1324,1327-1328,1330-1331,1336-1337,1339-1340,1347,1350-1351,1353,1357,1413-1414,1417,1434,1443,1455,1461,1516,1522,1524-1526,1533,1547,1550,1556,1558-1560,1565-1566,1569,1583-1584,1592,1594,1598,1600,1605,1607,1615,1620,1622,1632,1635,1638,1641,1645,1658,1677,1683,1688,1691,1694,1699,1701,1703,1707-1709,1711-1713,1715,1719,1721-1722,1730,1735-1736,1745,1750,1752-1753,1791-1792,1799-1800,1805-1808,1811-1812,1823,1825,1835,1839,1858,1861-1862,1871,1875,1883,1901,1911-1912,1914,1918,1924,1927,1954,1958,1971-1976,1981,1984,2011-2013,2021-2022,2025,2031,2034-2035,2038,2040-2048,2062,2067-2070,2080-2083,2086-2087,2095-2096,2099,2101,2104,2106,2111-2112,2115,2124,2134,2142,2148,2150,2170,2187,2196-2197,2200-2201,2203,2224,2232,2241,2250,2253,2261-2262,2265,2269-2271,2280,2288,2291-2292,2300,2302,2304,2312-2313,2323,2325-2326,2330,2335,2340,2366,2371-2372,2375-2376,2382,2391,2393-2394,2418,2425,2433,2435-2436,2438-2439,2449,2456,2463,2472,2501,2505,2531-2532,2550-2551,2557,2600,2608,2628,2638,2710,2725,2800,2903,2909-2910,2920,2968,3003,3006-3007,3013,3025,3050,3119,3162,3168,3221,3299,3304,3307,3322,3324,3376,3390,3399-3400,3410,3456,3514,3517,3527,3632,3684,3697,3700,3731,3792,3800,3808-3809,3814,3820,3824,3826,3846,3848-3849,3852-3853,3859,3863,3869-3870,3872,3878,3888-3889,3905,3907,3914,3916,3920,3929,3931,3941,3944-3945,3957,3963,3968-3969,3971-3972,3981,3990,3993-3994,3999,4004-4005,4009,4040,4080,4096,4125,4143,4147,4164,4200,4224,4252,4279,4321,4333,4343,4430,4445,4550,4555,4559,4567,4600,4658,4848,4875,4900,4949,4998,5010-5011,5033,5040,5061,5063,5074,5080-5081,5087,5151,5212,5221,5223,5242,5279,5339,5353,5440,5501,5520,5544,5560,5678,5680,5730,5802-5803,5807,5811-5812,5815,5818,5823,5850,5862,5868-5869,5899,5905-5907,5909,5914,5918,5938,5940,5950,5952,5968,5981,5998-5999,6006-6009,6017,6025,6050-6051,6060,6068,6100,6103,6203,6222,6247,6346,6481,6500,6504,6510,6520,6547,6550,6565-6567,6600,6662,6668-6670,6689,6692,6699,6711,6732,6779,6792,6839,6896,7003-7004,7010,7024-7025,7050-7051,7080,7123,7201,7241,7272,7278,7281,7438,7496,7676,7725,7744,7749,7770,7800,7878,7900,7913,7920-7921,7929,7999,8015-8016,8019,8022,8042,8045,8050,8093,8095,8097-8099,8118,8180,8189,8200,8254,8290,8292-8294,8300,8383,8385,8481,8500,8540,8648,8654,8675-8676,8686,8765-8766,8800,8877,8889,8987,8996,9003,9040,9081,9091,9098-9099,9103,9110-9111,9152,9191,9197-9198,9200,9409,9418,9443-9444,9501,9575,9600,9621,9643,9666,9673,9815,9877-9878,9898,9914,9917,9929,9941,9943-9944,9988,9992,9998,10003-10005,10008-10009,10011,10022-10023,10034,10058,10082-10083,10160,10180,10215,10778,10873,11111,12006,12021,12059,12174,12215,12262,12265,12346,12380,12452,13724,14441,15001,15004,15402,15742,16000,16012,16080,16113,16705,16800,16851,17595,17877,18000,18018,18040,18101,18264,18988,19283,19315,19350,19780,19900,20002,21792,22222,23052,23796,24444,25735,26000,26214,26470,27352-27353,27355-27357,28211,29672,29831,30005,30704,30951,31337,31727,32777-32780,32783-32785,32791-32792,32803,32816,32822,32835,33453,33554,35513,37839,38037,38185,38188,38292,39136,39376,39659,40000,40811,40911,41064,41511,41523,44176,44334,44442-44443,44501,44709,46200,46996,47544,49161,49163-49165,49167-49168,49171,49175-49176,49186,49195,49236,49400-49401,50050,50300,50389,50500,50636,51191,51413,51493,52660,52673,52710,52735,52847-52851,52853,53211,53313-53314,53535,54045,54328,55020,55055-55056,55576,56737-56738,57665,57797,58001-58002,58630,58632,58838,59110,59200-59202,60123,60146,60443,60642,61532,61613,61900,62078,65310"
	portgroup[4] = "21-23,25-26,53,80-81,110-111,113,135,139,143,179,199,443,445,465,514-515,548,554,587,646,993,995,1025-1027,1433,1720,1723,2000-2001,3306,3389,5060,5666,5900,6001,8000,8008,8080,8443,8888,10000,32768,49152,49154,1,7,9,13,17,19,37,79,82,88,100,106,119,144,255,389,427,444,513,543-544,625,631,636,808,873,990,1000,1024,1028-1031,1038-1039,1041,1044,1048-1049,1053-1054,1056,1064-1066,1069,1071,1110,1755,1801,1900,2049,2103,2105,2107,2121,2601,2717,2869,2967,3000-3001,3128,3689,3703,3986,4001,4899,5000-5001,5009,5050-5051,5101,5120,5190,5357,5432,5631,5800,5901,6000,6004,6646,7000,7070,8009-8010,8031,8081,9000,9090,9100,9102,9999,10010,49153,49155-49157,3-4,6,20,24,30,32-33,42-43,49,83,85,89-90,99,146,161,163,211-212,222,254,264,280,306,311,340,366,407,425,458,464,497,500,512,541,563,593,648,691,705,711,749,787,800,880,888,898,900-902,912,987,992,999,1001-1002,1022-1023,1032-1037,1040,1042-1043,1045-1047,1050-1052,1055,1057-1063,1067-1068,1070,1072-1075,1077-1083,1085-1089,1093-1094,1096-1100,1104,1106-1108,1111,1124,1148,1152,1169,1183,1186,1218,1234,1247-1248,1272,1296,1310-1311,1334,1352,1494,1500-1501,1503,1521,1580,1666,1687,1700,1717-1718,1761,1782-1783,1840,1863-1864,1935,1947,1998-1999,2002-2010,2020,2030,2033,2065,2100,2119,2126,2135,2144,2160-2161,2179,2190-2191,2222,2251,2260,2301,2381,2383,2399,2401,2492,2500,2522,2525,2602,2604-2605,2607,2701-2702,2718,2809,2811,2875,2998,3005,3011,3017,3030-3031,3052,3071,3077,3211,3260-3261,3268-3269,3283,3300-3301,3323,3325,3333,3351,3367,3369-3372,3404,3476,3493,3546,3551,3580,3659,3690,3737,3766,3784,3801,3827-3828,3851,3871,3880,3918,3995,3998,4000,4002-4003,4006,4045,4111,4126,4129,4242,4443-4444,4446,4449,4662,5002-5004,5030,5054,5100,5102,5200,5214,5222,5225-5226,5269,5280,5298,5405,5414,5431,5500,5510,5550,5555,5566,5633,5679,5718,5801,5810,5822,5825,5859,5877,5902-5904,5910-5911,5915,5922,5925,5959-5963,5987-5989,6002-6003,6005,6059,6101,6106,6112,6123,6129,6156,6389,6502,6543,6580,6666-6667,6788-6789,6881,6901,6969,7001-7002,7007,7019,7100,7103,7106,7200,7402,7435,7443,7512,7625,7627,7741,7777-7778,7911,7937-7938,8001-8002,8007,8011,8021,8082-8090,8100,8181,8192-8194,8222,8291,8333,8400,8402,8600,8649,8651-8652,8701,8873,8899,8994,9001-9002,9009-9011,9050,9071,9080,9101,9207,9220,9290,9415,9485,9500,9502-9503,9535,9593-9595,9618,9876,9900,9968,10001-10002,10012,10024-10025,10243,10566,10616-10617,10621,10626,10628-10629,11110,11967,12000,12345,13456,13722,13782-13783,14000,14238,14442,15000,15002-15003,15660,16001,16016,16018,16992-16993,17988,19101,19801,19842,20000,20005,20031,20221-20222,20828,21571,22939,23502,24800,25734,27000,27715,28201,30000,30718,31038,32769-32776,32781-32782,33354,33899,34571-34573,35500,40193,42510,45100,48080,49158-49160,49999-50003,50006,50800,51103,52822,52869,55555,55600,57294,58080,60020,63331,64623,64680,65000,65129,65389,27,55,57,59,70,77,84,86-87,98,102,109,123,125,127,157,210,220,223,225,250-252,256-257,259,301,333,388,406,411,416-417,419,441-442,447,475,481,502,523-524,540,545,555-557,600,602,606,610,616-617,621,623,639,641,655,657,659-660,666-669,674,683-684,687,690,700-701,709-710,713-715,720,722,725-726,728-732,740,748,754,757-758,765,777-778,780,782-783,786,790,792,795,801-803,805-806,822-823,825,829,839-840,843,846,856,859,862,864,874,878,903-905,911,913,918,921-922,924,928,930-931,943,953,969,971,980-981,996,998,1004-1015,1020-1021,1076,1084,1090-1092,1095,1101-1103,1105,1109,1112-1114,1116-1119,1121-1123,1125-1128,1130-1132,1134-1138,1141,1143-1145,1147,1149-1151,1153-1154,1156-1159,1162-1168,1173-1176,1179-1180,1182,1184-1185,1187-1188,1190-1192,1194-1196,1198-1201,1204,1207-1213,1215-1217,1220-1223,1228-1229,1233,1236,1239-1241,1243-1244,1249-1251,1259,1261-1262,1264,1268,1270-1271,1276-1277,1279,1282,1287,1290-1291,1297,1299-1303,1305-1309,1314-1319,1321-1322,1324,1327-1328,1330-1331,1336-1337,1339-1340,1347,1350-1351,1353,1357,1413-1414,1417,1434,1443,1455,1461,1516,1522,1524-1526,1533,1547,1550,1556,1558-1560,1565-1566,1569,1583-1584,1592,1594,1598,1600,1605,1607,1615,1620,1622,1632,1635,1638,1641,1645,1658,1677,1683,1688,1691,1694,1699,1701,1703,1707-1709,1711-1713,1715,1719,1721-1722,1730,1735-1736,1745,1750,1752-1753,1791-1792,1799-1800,1805-1808,1811-1812,1823,1825,1835,1839,1858,1861-1862,1871,1875,1883,1901,1911-1912,1914,1918,1924,1927,1954,1958,1971-1976,1981,1984,2011-2013,2021-2022,2025,2031,2034-2035,2038,2040-2048,2062,2067-2070,2080-2083,2086-2087,2095-2096,2099,2101,2104,2106,2111-2112,2115,2124,2134,2142,2148,2150,2170,2187,2196-2197,2200-2201,2203,2224,2232,2241,2250,2253,2261-2262,2265,2269-2271,2280,2288,2291-2292,2300,2302,2304,2312-2313,2323,2325-2326,2330,2335,2340,2366,2371-2372,2375-2376,2382,2391,2393-2394,2418,2425,2433,2435-2436,2438-2439,2449,2456,2463,2472,2501,2505,2531-2532,2550-2551,2557,2600,2608,2628,2638,2710,2725,2800,2903,2909-2910,2920,2968,3003,3006-3007,3013,3025,3050,3119,3162,3168,3221,3299,3304,3307,3322,3324,3376,3390,3399-3400,3410,3456,3514,3517,3527,3632,3684,3697,3700,3731,3792,3800,3808-3809,3814,3820,3824,3826,3846,3848-3849,3852-3853,3859,3863,3869-3870,3872,3878,3888-3889,3905,3907,3914,3916,3920,3929,3931,3941,3944-3945,3957,3963,3968-3969,3971-3972,3981,3990,3993-3994,3999,4004-4005,4009,4040,4080,4096,4125,4143,4147,4164,4200,4224,4252,4279,4321,4333,4343,4430,4445,4550,4555,4559,4567,4600,4658,4848,4875,4900,4949,4998,5010-5011,5033,5040,5061,5063,5074,5080-5081,5087,5151,5212,5221,5223,5242,5279,5339,5353,5440,5501,5520,5544,5560,5678,5680,5730,5802-5803,5807,5811-5812,5815,5818,5823,5850,5862,5868-5869,5899,5905-5907,5909,5914,5918,5938,5940,5950,5952,5968,5981,5998-5999,6006-6009,6017,6025,6050-6051,6060,6068,6100,6103,6203,6222,6247,6346,6481,6500,6504,6510,6520,6547,6550,6565-6567,6600,6662,6668-6670,6689,6692,6699,6711,6732,6779,6792,6839,6896,7003-7004,7010,7024-7025,7050-7051,7080,7123,7201,7241,7272,7278,7281,7438,7496,7676,7725,7744,7749,7770,7800,7878,7900,7913,7920-7921,7929,7999,8015-8016,8019,8022,8042,8045,8050,8093,8095,8097-8099,8118,8180,8189,8200,8254,8290,8292-8294,8300,8383,8385,8481,8500,8540,8648,8654,8675-8676,8686,8765-8766,8800,8877,8889,8987,8996,9003,9040,9081,9091,9098-9099,9103,9110-9111,9152,9191,9197-9198,9200,9409,9418,9443-9444,9501,9575,9600,9621,9643,9666,9673,9815,9877-9878,9898,9914,9917,9929,9941,9943-9944,9988,9992,9998,10003-10005,10008-10009,10011,10022-10023,10034,10058,10082-10083,10160,10180,10215,10778,10873,11111,12006,12021,12059,12174,12215,12262,12265,12346,12380,12452,13724,14441,15001,15004,15402,15742,16000,16012,16080,16113,16705,16800,16851,17595,17877,18000,18018,18040,18101,18264,18988,19283,19315,19350,19780,19900,20002,21792,22222,23052,23796,24444,25735,26000,26214,26470,27352-27353,27355-27357,28211,29672,29831,30005,30704,30951,31337,31727,32777-32780,32783-32785,32791-32792,32803,32816,32822,32835,33453,33554,35513,37839,38037,38185,38188,38292,39136,39376,39659,40000,40811,40911,41064,41511,41523,44176,44334,44442-44443,44501,44709,46200,46996,47544,49161,49163-49165,49167-49168,49171,49175-49176,49186,49195,49236,49400-49401,50050,50300,50389,50500,50636,51191,51413,51493,52660,52673,52710,52735,52847-52851,52853,53211,53313-53314,53535,54045,54328,55020,55055-55056,55576,56737-56738,57665,57797,58001-58002,58630,58632,58838,59110,59200-59202,60123,60146,60443,60642,61532,61613,61900,62078,65310"

	wg.Add(len(portgroup))
	for i := 0; i < len(portgroup); i++ {
		var args []string
		outputfile := r.Opts.Directory + "profile_" + ip + "_" + "_" + strconv.Itoa(i) + "_" + time.Now().Format("2006-01-02_150405") + ".xml"
		if i == 4 {
			args = []string{"--open", "--version-intensity=0", "--min-rate=150", "--initial-rtt-timeout=50ms", "--max-rtt-timeout=200ms", "--max-scan-delay=5", "-Pn", "-sS", "-p-", "--exclude-ports", portgroup[i], "-oX", outputfile, ip}
		} else {
			args = []string{"--open", "--version-intensity=0", "--min-rate=150", "--initial-rtt-timeout=50ms", "--max-rtt-timeout=200ms", "--max-scan-delay=5", "-Pn", "-sS", "-p", portgroup[i], "-oX", outputfile, ip}
		}
		go worker("nmap", args, outputfile, r, wg)
	}
	return nil, nil
}
